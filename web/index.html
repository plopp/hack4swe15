<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="css/style.css" />
	<script type="text/javascript" src="js/base.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
	<script type='text/javascript' src='js/overlaycanvas.js'></script>
	<script type='text/javascript' src='bower_components/pathfinding/pathfinding-browser.js'></script>
	<script type='text/javascript' src='js/astar.js'></script>
</head>
<body>
<script type="text/javascript">
	var layerStyle = [[
	  {
	    "featureType": "transit",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  },{
	    "featureType": "landscape",
	    "stylers": [
	      { "saturation": -100 },
	      { "invert_lightness": true },
	      { "lightness": 7 }
	    ]
	  },{
	    "featureType": "poi",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  },{
	    "featureType": "water",
	    "stylers": [
	      { "saturation": -100 },
	      { "lightness": -77 },
	      { "color": "#000000" }
	    ]
	  },{
	    "featureType": "road",
	    "elementType": "geometry",
	    "stylers": [
	      { "visibility": "simplified" },
	      { "weight": 1.6 },
	      { "color": "#ffba01" }
	    ]
	  },{
	    "featureType": "administrative",
	    "stylers": [
	      { "visibility": "on" },
	      { "invert_lightness": true }
	    ]
	  },{
	    "featureType": "road",
	    "elementType": "labels",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  }
	],[
	  {
	    "featureType": "transit",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  },{
	    "featureType": "landscape",
	    "stylers": [
	      { "saturation": -40 },
	      { "invert_lightness": true },
	      { "lightness": 8 }
	    ]
	  },{
	    "featureType": "poi",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  },{
	    "featureType": "water",
	    "stylers": [
	      { "saturation": -100 },
	      { "lightness": -77 },
	      { "color": "#000000" }
	    ]
	  },{
	    "featureType": "road",
	    "elementType": "geometry",
	    "stylers": [
	      { "visibility": "simplified" },
	      { "weight": 2.6 },
	      { "color": "#baff01" }
	    ]
	  },{
	    "featureType": "administrative",
	    "stylers": [
	      { "visibility": "on" },
	      { "invert_lightness": true }
	    ]
	  },{
	    "featureType": "road",
	    "elementType": "labels",
	    "stylers": [
	      { "visibility": "off" }
	    ]
	  }
	]];
	</script>
		<div id="map"></div>
		<div id="overlay"></div>
		<div id="graph"></div>
		<div id="params"></div>
		<div id="debug"></div>

		<script type="text/javascript">
				window.addEventListener('load', function() {
					var nofPoints = 0 //Counts clicks
					var waitingForStartClick = false;
					var waitingForEndClick = false;
					var butts =document.getElementsByTagName("button");
					var startx = 0;
					var starty = 0;
					var endx = 0;
					var endy = 0;
					for(var z =0; z < butts.length; z++){
						var elem = butts[z];
						//console.log(elem);
						elem.onclick = function(event){
							var id = event.toElement.id;
							switch(id){
								case "setStart":
									waitingForStartClick = true;
									console.log("Start");
									break;
								case "setEnd":
									waitingForEndClick = true;
									console.log("End");
									break;
							}
						}
					}

					var centerlatlng = new google.maps.LatLng(60.627800,15.660929);

					var myOptions = {
						disableDefaultUI: true,
						zoom:14,
						center:centerlatlng,
						mapTypeId:google.maps.MapTypeId.SATELLITE,
						draggableCursor:'crosshair',
						//styles:layerStyle[0],
						scaleControl:false
					};

					var map = new google.maps.Map(document.getElementById("map"),myOptions);

					google.maps.event.addListener(map, 'click', function(event) {
						console.log(cntDiv);
						switch(nofPoints){
							case 0:
								startx = event.pixel.x;
								starty = event.pixel.y;
								console.log("Start: "+startx+" "+starty);
								document.getElementById("clickStatus").innerHTML = "Select point B!";
								nofPoints++;
								break;
							case 1:
								endx = event.pixel.x;
								endy = event.pixel.y;
								console.log("End: "+endx+" "+endy);
								document.getElementById("clickStatus").innerHTML = "Select point A!";

								finder.getMergedArray(prepareSearch);
								nofPoints = 0;
								break;
						}
						console.log(nofPoints);
				    	console.log(event.pixel);
				  	});

				  	google.maps.event.addListenerOnce(map,"projection_changed", function() {
						projection = map.getProjection();

						console.log('prjection change',projection);
					});

					var canvasElement = document.createElement('canvas');
					canvasElement.width = '1000';
					canvasElement.height = '500';
					canvasElement.style.width = '100%';
					canvasElement.style.height = '100%';

					var cntDiv = document.createElement('div');
					cntDiv.style.position = 'absolute';
					cntDiv.style.width = '100%';
					cntDiv.style.height = '100%';
					cntDiv.appendChild(canvasElement);

					var sw = new google.maps.LatLng(60.627800,15.660929);
					var ne = new google.maps.LatLng(60.645859,15.724571);
					var bn = new google.maps.LatLngBounds(sw,ne);

					overlay = new SimulatorOverlay(bn, cntDiv, map,function(){
						console.log("Added overlay");
					}/*,sim*/);

					var prepareSearch = function(data) {
						// console.log('prepareSearch', data);
						startx = 40;
						starty = 40;
						endx = data[0].length - 40;
						endy = data.length - 40;
						if(startx == 0 && starty == 0 && endx == 0 && endy == 0){
							return;
						}

						var grid = new PF.Grid(data[0].length, data.length, data);
						for(var j=0; j<data.length-1; j++) {
							for(var i=0; i<data[0].length-1; i++) {
								grid.setWalkableAt(i, j, true);
								grid.setWeightAt(i, j, data[j][i]);
							}
						}
						var pathfinder = new PF.AStarFinder({
							heuristic: PF.Heuristic.euclidean
						});
						var result = pathfinder.findPath(startx, starty, endx, endy, grid);
						console.log('result', result);

						// // var graph = new Graph(data, { diagonal: false });
						// var start = graph.grid[starty][startx];
						// var end = graph.grid[endy][endx];

						var ctx = canvasElement.getContext("2d");
						ctx.clearRect(0,0,canvasElement.width,canvasElement.height);
						ctx.fillStyle = "#FF0000";
						ctx.strokeStyle = "#FF0000";

						finder.drawDebug(ctx);

						ctx.beginPath();
						ctx.rect(0,0,canvasElement.width,canvasElement.height);
						console.log("Area size: "+canvasElement.width+"px "+canvasElement.height+"px");
						ctx.stroke();

						ctx.beginPath();
						// var result = astar.search(graph, start, end);

						var flightPlanCoordinates = [
						  ];

						for (var i = 0; i < result.length; i++) {

							var x = result[i][0];
							var y = result[i][1];
							console.log(x,y,overlay);

							var latLng = overlay.getPos(x,y);//overlay.projection.fromPointToLatLng(x,y);
							
							flightPlanCoordinates.push(latLng);
						}

						  var flightPath = new google.maps.Polyline({
						    path: flightPlanCoordinates,
						    geodesic: true,
						    strokeColor: '#FF0000',
						    strokeOpacity: 1.0,
						    strokeWeight: 2
						  });

						  flightPath.setMap(map);


						

						for (var i = 0; i < result.length; i++) {
							var x = result[i][0];
							var y = result[i][1];
							/* if (result[i].closed) {
								ctx.strokeStyle = 'green';
								ctx.lineTo(x,y);
								ctx.moveTo(x,y);
							} else {
							*/
							ctx.strokeStyle = 'blue';
							ctx.lineTo(x,y);
							ctx.moveTo(x,y);
							// }
						};
						ctx.stroke();
					}

					var constraintChangeCallback = function(){
						console.log("Changed!");
						finder.getMergedArray(prepareSearch);
					}

					finder = window.initSearch(map,constraintChangeCallback);
					var projection;
					

					// result is an array containing the shortest path
				});

		</script>
		<div class="guidiv">
			<button id="setStart">Set start point</button>
			<button id="setEnd">Set end point</button>
			<div id="clickStatus" style="width: 100px; height: 40px; color: #000000; background: #FFFFFF; padding: 10px; margin: 4px">Select point A!</div>
		</div>
</body>
</html>